rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && (
        request.auth.uid == 't2OotVn0rwd7EC56ii8DvkgMTdH2' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    function isBestie(userId) {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/besties/$(request.auth.uid + '_' + userId)) ||
        exists(/databases/$(database)/documents/besties/$(userId + '_' + request.auth.uid))
      );
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId) && 
        (!request.resource.data.keys().hasAny(['role', 'banned']));
      allow delete: if isAdmin();
    }
    
    // Check-ins collection
    match /checkins/{checkInId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        request.auth.uid in resource.data.bestieIds ||
        isAdmin()
      );
      
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.keys().hasAll(['userId', 'location', 'duration', 'bestieIds', 'status', 'createdAt']) &&
        request.resource.data.status == 'active' &&
        request.resource.data.duration >= 15 &&
        request.resource.data.duration <= 180 &&
        request.resource.data.bestieIds.size() > 0 &&
        request.resource.data.bestieIds.size() <= 5;
      
      allow update: if isSignedIn() && (
        isOwner(resource.data.userId) ||
        (request.auth.uid in resource.data.bestieIds && 
         request.resource.data.status == 'false_alarm')
      );
      
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Besties collection
    match /besties/{bestieId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.requesterId ||
        request.auth.uid == resource.data.recipientId ||
        isAdmin()
      );
      
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.requesterId &&
        request.resource.data.keys().hasAll(['requesterId', 'recipientPhone', 'status', 'createdAt']) &&
        request.resource.data.status == 'pending';
      
      allow update: if isSignedIn() && (
        (request.auth.uid == resource.data.recipientId && 
         request.resource.data.status in ['accepted', 'declined']) ||
        (request.auth.uid == resource.data.requesterId && 
         request.resource.data.status == 'cancelled')
      );
      
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.requesterId ||
        request.auth.uid == resource.data.recipientId ||
        isAdmin()
      );
    }
    
    // Templates collection
    match /templates/{templateId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.userId;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Badges collection
    match /badges/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create, update: if false; // Only Cloud Functions
      allow delete: if isAdmin();
    }
    
    // Analytics collections (admin-only read)
    match /errors/{errorId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    match /performance/{perfId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    match /user_actions/{actionId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    match /funnel_events/{eventId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Alerts collection
    match /alerts/{alertId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties ||
        isAdmin()
      );
      allow create: if false; // Only Cloud Functions
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties
      );
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if false; // Only Cloud Functions
      allow update: if isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }
    
    // Emergency SOS collection
    match /emergency_sos/{sosId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties ||
        isAdmin()
      );
      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.notifiedBesties
      );
      allow delete: if isAdmin();
    }

    // Forum Threads collection
    match /threads/{threadId} {
      // Anyone can read threads
      allow read: if true;

      // Only signed-in users can create threads
      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.authorId &&
        request.resource.data.keys().hasAll(['title', 'content', 'authorId', 'authorName', 'category', 'createdAt']) &&
        request.resource.data.category in ['general', 'feature-request', 'bug-report', 'help', 'announcement'] &&
        (request.resource.data.category != 'announcement' || isAdmin()) &&
        request.resource.data.title.size() > 0 &&
        request.resource.data.title.size() <= 200 &&
        request.resource.data.content.size() > 0 &&
        request.resource.data.content.size() <= 50000;

      // Authors can update their own threads, admins can pin/lock
      allow update: if isSignedIn() && (
        (isOwner(resource.data.authorId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['authorId', 'isPinned', 'isLocked', 'voteCount', 'upvotes', 'downvotes', 'replyCount', 'viewCount'])) ||
        (isAdmin() &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['authorId', 'voteCount', 'upvotes', 'downvotes', 'replyCount']))
      );

      // Authors and admins can delete threads
      allow delete: if isSignedIn() && (
        isOwner(resource.data.authorId) || isAdmin()
      );

      // Thread Votes subcollection
      match /votes/{userId} {
        allow read: if true;
        allow create: if isSignedIn() &&
          request.auth.uid == userId &&
          request.resource.data.vote in [1, -1];
        allow update: if isSignedIn() &&
          request.auth.uid == userId &&
          request.resource.data.vote in [1, -1];
        allow delete: if isSignedIn() && request.auth.uid == userId;
      }

      // Thread Replies subcollection
      match /replies/{replyId} {
        allow read: if true;
        allow create: if isSignedIn() &&
          request.auth.uid == request.resource.data.authorId &&
          request.resource.data.keys().hasAll(['content', 'authorId', 'authorName', 'threadId', 'createdAt']) &&
          request.resource.data.content.size() > 0 &&
          request.resource.data.content.size() <= 50000;
        allow update: if isSignedIn() && (
          (isOwner(resource.data.authorId) &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['authorId', 'threadId', 'voteCount', 'upvotes', 'downvotes', 'isAccepted'])) ||
          (isAdmin())
        );
        allow delete: if isSignedIn() && (
          isOwner(resource.data.authorId) || isAdmin()
        );

        // Reply Votes subcollection
        match /votes/{userId} {
          allow read: if true;
          allow create: if isSignedIn() &&
            request.auth.uid == userId &&
            request.resource.data.vote in [1, -1];
          allow update: if isSignedIn() &&
            request.auth.uid == userId &&
            request.resource.data.vote in [1, -1];
          allow delete: if isSignedIn() && request.auth.uid == userId;
        }
      }
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
